{% extends 'base.html' %}
{% block content %}

<h2 class="mb-4 fw-bold">Reports</h2>

<!-- Filter Form -->
<div class="card p-3 mb-4 shadow">
  <form method="get" class="row g-3">
    <div class="col-md-2">{{ form.start_date.label_tag }} {{ form.start_date }}</div>
    <div class="col-md-2">{{ form.end_date.label_tag }} {{ form.end_date }}</div>
    <div class="col-md-2">{{ form.exam_name.label_tag }} {{ form.exam_name }}</div>
    <div class="col-md-2">{{ form.exam_type.label_tag }} {{ form.exam_type }}</div>
    <div class="col-md-2">{{ form.referred_by.label_tag }} {{ form.referred_by }}</div>
    <div class="col-md-2">{{ form.sonologist.label_tag }} {{ form.sonologist }}</div>
    <!-- Search Input -->
    <div class="col-md-2">
      <input type="text" name="search" id="search" class="form-control" 
             value="{{ request.GET.search }}" placeholder="Search">
    </div>

    <div class="col-md-12">
      <button type="submit" class="btn btn-primary mt-2">Filter</button>
      <a href="{% url 'reports:export' 'xlsx' %}?{{ request.GET.urlencode }}" class="btn btn-success mt-2">⬇ Excel</a>
      {% comment %} <a href="{% url 'reports:export' 'pdf' %}?{{ request.GET.urlencode }}" class="btn btn-danger mt-2">⬇ Export PDF</a> {% endcomment %}
    </div>
  </form>
</div>

<!-- Reports Table -->
<h3>Recent Reports</h3>
<table class="table table-bordered">
  <thead class="table-light">
    <tr>
      <th>Patient ID</th>
      <th>Date</th>
      <th>Exam Name</th>
      <th>Exam Type</th>
      <th>Referred By</th>
      <th>Sonologist</th>
      <th>Total Ultra</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for r in reports %}
      <tr>
        <td>{{ r.id_number|default:"—" }}</td>
        <td>{{ r.date|date:"d M Y" }}</td>

        <td>
          {% if r.exam_name %}{{ r.exam_name.name }}{% else %}—{% endif %}
        </td>

        <td>
          {% if r.exam_type %}{{ r.exam_type.name }}{% else %}—{% endif %}
        </td>

        <td>
          {% if r.referred_by %}{{ r.referred_by.name }}{% else %}—{% endif %}
        </td>

        <td>
          {% if r.sonologist %}{{ r.sonologist.name }}{% else %}—{% endif %}
        </td>

        <td>{{ r.total_ultra }}</td>

        <td>
          <a href="{% url 'reports:report_edit' r.id %}" class="btn btn-sm btn-warning">Edit</a>
        </td>
      </tr>
    {% empty %}
      <tr><td colspan="8">No records found</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- Reports Pagination -->
{% if reports.paginator.num_pages > 1 %}
  <nav aria-label="Reports pagination">
    <ul class="pagination justify-content-center mt-3">
      {% with querystring=request.GET.urlencode|cut:"page="|cut:"&page=" %}
        {% if reports.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page=1{% if querystring %}&{{ querystring }}{% endif %}">« First</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ reports.previous_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">‹ Prev</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">« First</span></li>
          <li class="page-item disabled"><span class="page-link">‹ Prev</span></li>
        {% endif %}

        <li class="page-item active">
          <span class="page-link">Page {{ reports.number }} of {{ reports.paginator.num_pages }}</span>
        </li>

        {% if reports.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ reports.next_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">Next ›</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ reports.paginator.num_pages }}{% if querystring %}&{{ querystring }}{% endif %}">Last »</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Next ›</span></li>
          <li class="page-item disabled"><span class="page-link">Last »</span></li>
        {% endif %}
      {% endwith %}
    </ul>
  </nav>
{% endif %}

{% endblock %}
