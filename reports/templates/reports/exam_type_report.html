{% extends 'base.html' %}
{% load form_tags %}

{% block content %}
<h2 class="mb-4 fw-bold">USG Report by Sonologist & Exam Type</h2>

<!-- Filter Form -->
<div class="card p-4 mb-4 shadow-sm">
  <h5 class="mb-3">Filter USG Reports</h5>
  <form method="get" class="row g-3 align-items-end">
    <div class="col-md-3">
      <label class="form-label">{{ form.start_date.label }}</label>
      {{ form.start_date|add_class:"form-control date-picker" }}
    </div>
    <div class="col-md-3">
      <label class="form-label">{{ form.end_date.label }}</label>
      {{ form.end_date|add_class:"form-control date-picker" }}
    </div>
    <div class="col-md-3">
      {{ form.sonologist.label_tag }}
      {{ form.sonologist|add_class:"form-control" }}
    </div>
    <div class="col-md-3">
      {{ form.exam_type.label_tag }}
      {{ form.exam_type|add_class:"form-control" }}
    </div>
    <div class="col-md-3 d-grid mt-2">
      <button class="btn btn-primary">Filter</button>
    </div>
  </form>
</div>

<!-- Export -->
<div class="mb-3 d-flex gap-2">
  <a href="{% url 'reports:exam_type_export' 'xlsx' %}?{{ request.GET.urlencode }}" class="btn btn-success">⬇ Excel</a>
  <a href="{% url 'reports:exam_type_export' 'pdf' %}?{{ request.GET.urlencode }}" class="btn btn-danger">⬇ PDF</a>
</div>

<!-- GROUPED TABLE -->
<div class="card shadow-sm p-3">
  <table class="table table-bordered table-hover">
    <thead class="table-secondary">
      <tr>
        <th>Sonologist</th>
        <th>Exam Type</th>
        <th>Total Ultras</th>
      </tr>
    </thead>
    <tbody>

      {% if grouped_reports %}
        {% for sonologist, data in grouped_reports %}
          <!-- Sonologist Header -->
          <tr class="table-primary fw-bold">
            <td colspan="3">{{ sonologist }}</td>
          </tr>

          <!-- Exam Types -->
          {% for item in data.exams %}
            <tr>
              <td></td>
              <td>{{ item.exam_type }}</td>
              <td>{{ item.total_usg }}</td>
            </tr>
          {% endfor %}

          <!-- TOTAL USG per Sonologist -->
          <tr class="fw-bold table-light">
            <td></td>
            <td class="text-end">Total USG:</td>
            <td>{{ data.total_usg }}</td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="3" class="text-center">No records found</td></tr>
      {% endif %}

      <!-- Grand Total USG -->
      <tr class="table-dark fw-bold">
        <td colspan="2" class="text-end">Grand Total USG</td>
        <td>{{ grand_total_usg }}</td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Pagination Controls -->
{% if page_obj.has_other_pages %}
<nav aria-label="Page navigation">
  <ul class="pagination justify-content-center">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page=1&start_date={{ start_date }}&end_date={{ end_date }}{% if form.cleaned_data.sonologist %}&sonologist={{ form.cleaned_data.sonologist.id }}{% endif %}{% if form.cleaned_data.exam_type %}&exam_type={{ form.cleaned_data.exam_type.id }}{% endif %}">First</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}&start_date={{ start_date }}&end_date={{ end_date }}{% if form.cleaned_data.sonologist %}&sonologist={{ form.cleaned_data.sonologist.id }}{% endif %}{% if form.cleaned_data.exam_type %}&exam_type={{ form.cleaned_data.exam_type.id }}{% endif %}">Previous</a>
      </li>
    {% endif %}

    <li class="page-item disabled">
      <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
    </li>

    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}&start_date={{ start_date }}&end_date={{ end_date }}{% if form.cleaned_data.sonologist %}&sonologist={{ form.cleaned_data.sonologist.id }}{% endif %}{% if form.cleaned_data.exam_type %}&exam_type={{ form.cleaned_data.exam_type.id }}{% endif %}">Next</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&start_date={{ start_date }}&end_date={{ end_date }}{% if form.cleaned_data.sonologist %}&sonologist={{ form.cleaned_data.sonologist.id }}{% endif %}{% if form.cleaned_data.exam_type %}&exam_type={{ form.cleaned_data.exam_type.id }}{% endif %}">Last</a>
      </li>
    {% endif %}
  </ul>
</nav>
{% endif %}

{% endblock %}
